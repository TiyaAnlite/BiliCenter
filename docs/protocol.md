# 协议
这里列出了各个中间件在通讯传递过程中的协议细节，协议本身采用JSON传递，根据不同的字段实现不同的协议功能



### Event

由各中间件按照下述格式生成事件之后交由并发中心进行任务调度

实现参见`bilicenter_middleware/event.py`

```json
{
    "eid": "61e16ac3-76bd-524d-a897-60b1d16de18e",
    "source": "0102",
    "job": {}
}
```

| keys             | values                |
| ---------------- | --------------------- |
| eid              | 唯一事件ID            |
| callback_channel | 事件完成后回调的频道  |
| job              | SCF jobs 详见下述内容 |



### SCF jobs

并发中心将任务部署至分布式SCF采用的交换格式

实现参见`bilicenter_middleware/event2job.py`

#### 任务部署

```json
{
    "job_codec": "0102",
    "kwargs": {
        "arg_key": "arg_value"
    }
}
```

| keys      | values           |
| --------- | ---------------- |
| job_codec | 经编码的任务编码 |
| kwargs    | 传递给任务的参数 |



#### 事件回调数据

```json
{
    "code": 200,
    "msg": "ok",
    "rid": "9ac005ada66a1c454ab0c0cbf40d7eaf",
    "source": "0102",
    "eid": "f85a307e-656d-5e18-a413-1b3419e829c2",
    "data": {}
}
```

| keys   | values                          |
| ------ | ------------------------------- |
| code   | 任务返回码                      |
| msg    | 任务消息                        |
| rid    | 标志本次部署SCF任务的request_id |
| source | 事件发起的中间件                |
| eid    | 事件ID                          |
| data   | 任务结构负载                    |



#### 事件处理规则

一般情况下，并发中心接收一个事件请求，便立即将其放入调度队列，以供执行，若正常执行成功，则正常返回数据

若执行返回数据显示异常，则进行以下判断：

- 接口返回412，提示访问被封禁，或返回500，提示信息解析过程中错误，并发中心将会发起总共两次重试，只要请求成功则回调正常数据，直到重试结束仍未成功，回调最后一次失败数据，并同时将回调数据放入死信队列，放弃尝试
- 接口返回非412或500，不再做后续尝试，并继续将此次结果推送至回调中心，并记录至警告日志[SCF code]
- 从返回中读到`stackTrace`信息，提示分布式SCF侧发生未捕获异常，直接将将回调数据放入死信队列，不再尝试
- 云函数SDK捕获到异常，会持续进行重试，并记录至警告日志[SCF SDK error]
- 并发中心会监测死信队列和警告日志情况，并在必要时推送提醒信息



### Logs

是存储在Redis当中用于记录各中间件运行过程中的值得注意的警告信息，在达到一定阈值后将会触发提醒信息推送，具体到Redis中的键为`logs`的数据结构为列表(list)

```json
{
    "msg_type": "SCF 404",
    "content": {
        "event": {},
        "msg": "xxxxx"
    }
}
```

| keys     | values                                     |
| -------- | ------------------------------------------ |
| msg_type | 消息类型                                   |
| content  | 具体消息的负载，不同消息的负载结构有所不同 |



### DeadLetter

死信队列是一个需要非常关注的区域，这个区域存放了并发中心在部署任务时，最终因为某种原因导致失败的事件回调消息，会详细记录时间发生的时间与相关信息便于问题定位，出于稳定性和事件完整性考虑，一旦死信队列存在内容，会立即触发提醒消息推送。具体到Redis中的键为`dead_letter`的数据结构为列表(list)

死信队列中的数据结构同**事件回调信息**一致

